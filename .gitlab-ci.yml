stages: [push]

variables:
  DOCKER_TLS_CERTDIR: ""
  DOCKER_HOST: tcp://docker:2375
 
  PROJECT_SLUG: "a507_car"
  IMAGE_REPO:   "${DOCKER_HUB_USERNAME}/${PROJECT_SLUG}"
  IMAGE_SHA:    "${IMAGE_REPO}:${CI_COMMIT_SHA}"
  IMAGE_LATEST: "${IMAGE_REPO}:latest"

push-image:
  stage: push
  tags: 
    - be
  image: docker:latest 
  services: [docker:dind]
  script:
    # 1. Docker Hub 로그인
    - echo "Logging in to Docker Hub..."
    - echo "$DOCKER_HUB_TOKEN" | docker login -u "$DOCKER_HUB_USERNAME" --password-stdin

    # 2. Docker 이미지 빌드 (latest와 commit SHA 태그 동시 적용)
    - echo "Building Docker image..."
    - docker build -t "$IMAGE_LATEST" -t "$IMAGE_SHA" .

    # 3. Docker Hub로 푸시
    - echo "Pushing image to Docker Hub..."
    - docker push "$IMAGE_LATEST"
    - docker push "$IMAGE_SHA"

    - echo "CI pipeline finished successfully!"
  rules:
    - if: '$CI_PIPELINE_SOURCE == "push"'