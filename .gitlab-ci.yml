# CI/CD íŒŒì´í”„ë¼ì¸
workflow:
  rules:
    - if: '$CI_COMMIT_BRANCH == "master" || $CI_COMMIT_BRANCH == "develop"'
stages:
  - push
#ë³€ìˆ˜
variables:
  # ë³€ìˆ˜ëŠ” ì´ë¯¸ì§€ ì´ë¦„ì„ ë§Œë“œëŠ” ë° ì—¬ì „ížˆ í•„ìš”í•©ë‹ˆë‹¤.
  PRIVATE_REGISTRY: "localhost:5000"
  IMAGE_REPO_BACKEND: "${PRIVATE_REGISTRY}/a507_car"
  IMAGE_SHA_BACKEND: "${IMAGE_REPO_BACKEND}:${CI_COMMIT_SHA}"
  IMAGE_LATEST_BACKEND: "${IMAGE_REPO_BACKEND}:latest"
  IMAGE_REPO_FRONTEND: "${PRIVATE_REGISTRY}/a507_frontend"
  IMAGE_SHA_FRONTEND: "${IMAGE_REPO_FRONTEND}:${CI_COMMIT_SHA}"
  IMAGE_LATEST_FRONTEND: "${IMAGE_REPO_FRONTEND}:latest"

push-backend-image:
  stage: push
  tags:
    - be
    - master
    - develop
  script:
    - echo "Building and pushing backend image..."
    - docker build -t "$IMAGE_LATEST_BACKEND" -t "$IMAGE_SHA_BACKEND" -f ./backend/Dockerfile .
    - docker push "$IMAGE_LATEST_BACKEND"
    - docker push "$IMAGE_SHA_BACKEND"
    - echo "Backend CI pipeline finished successfully!"
  rules:
    - if: $CI_COMMIT_BRANCH == "master" || $CI_COMMIT_BRANCH == "develop"'
      changes:
        - backend/**/*
        - .gitlab-ci.yml
        - nginx/default.conf
# í”„ë¡ íŠ¸ì—”ë“œ
push-frontend-image:
  stage: push
  tags:
    - master
    - develop
  script:
      # --- ðŸ’¡ ë””ë²„ê¹…ìš© ì½”ë“œ ì¶”ê°€ ì‹œìž‘ ðŸ’¡ ---
    - echo "================================================"
    - echo "CI/CD ë³€ìˆ˜ ê°’ì„ í™•ì¸í•©ë‹ˆë‹¤."
    - echo "VITE_API_BASE ë³€ìˆ˜ ê°’ ---> ${VITE_API_BASE}"
    - echo "VITE_WS_BASE ë³€ìˆ˜ ê°’ ---> ${VITE_WS_BASE}"
    - echo "================================================"
    # --- ë””ë²„ê¹…ìš© ì½”ë“œ ì¶”ê°€ ë ---
    # GitLab ë³€ìˆ˜ë¥¼ ì‚¬ìš©í•´ ë¹Œë“œ ì§ì „ì— frontend/.env íŒŒì¼ì„ ìƒì„±í•©ë‹ˆë‹¤.
    - echo "VITE_API_BASE=${VITE_API_BASE}" > ./frontend/.env
    - echo "VITE_WS_BASE=${VITE_WS_BASE}" >> ./frontend/.env

    - echo "Building and pushing frontend image..."
    - docker build -t "$IMAGE_LATEST_FRONTEND" -t "$IMAGE_SHA_FRONTEND" -f ./frontend/Dockerfile .
    - docker push "$IMAGE_LATEST_FRONTEND"
    - docker push "$IMAGE_SHA_FRONTEND"
    - echo "Frontend CI pipeline finished successfully!"
  rules:
    - if: $CI_COMMIT_BRANCH == "master" || $CI_COMMIT_BRANCH == "develop"'
      changes:
        - frontend/**/*
        - .gitlab-ci.yml
        - default.conf
