# .gitlab-ci.yml (수동 배포용: build/push만 자동)
stages: [push]

# Docker Hub는 2단계 path를 허용하지 않음: <user>/<single-repo>
# => 안전하게 slug로 평탄화해서 '-backend' 접미사 사용
variables:
  IMAGE_REPO: "${DOCKER_HUB_USERNAME}/${CI_PROJECT_PATH_SLUG}-backend"
  IMAGE_SHA:  "${IMAGE_REPO}:${CI_COMMIT_SHA}"
  IMAGE_LATEST: "${IMAGE_REPO}:latest"
  DOCKER_BUILDKIT: "1"

push-image:
  stage: push
  image: docker:27
  services:
    - docker:27-dind
  # tags:  # <-- 러너 태그 요구 제거(공유 러너 사용)
  script:
    - echo "$DOCKER_HUB_TOKEN" | docker login -u "$DOCKER_HUB_USERNAME" --password-stdin docker.io
    - docker build -t "$IMAGE_SHA" -f Dockerfile .
    - docker push "$IMAGE_SHA"
    - docker tag "$IMAGE_SHA" "$IMAGE_LATEST"
    - docker push "$IMAGE_LATEST"
  # 브랜치 제한 제거 → 어떤 브랜치 push든 파이프라인 생성
  rules:
    - if: '$CI_PIPELINE_SOURCE == "push"'
